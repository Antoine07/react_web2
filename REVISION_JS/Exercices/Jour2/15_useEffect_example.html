<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8" />
    <title>Weather Forecast</title>
    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <!-- React CDN -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
        const { useState, useEffect } = React

        /**
    
            Montage composant â†’ fetch lancÃ©
            â†“
            L'utilisateur ferme (dÃ©montage du composant WeatherData
                    â†“
            Sans abort : fetch continue â†’ data â†’ setState â†’ ðŸ’¥ erreur
            Avec abort : fetch stoppÃ© â†’  âœ… propre
        */


        function App() {
            const [status, setStatus] = useState(true)

            return (
                <div>
                    <button onClick={() => setStatus(!status)}>Show weather NY</button>

                    {/* Quand status est true â†’ on affiche WeatherData,
                    quand il passe Ã  false â†’ WeatherData se dÃ©monte */}
                    {status && <WeatherData />}
                </div>
            )
        }

        function WeatherData() {
            const [weather, setWeather] = useState(null);
            const [loading, setLoading] = useState(true);

            /*
              useEffect(...) s'exÃ©cute aprÃ¨s l'affichage initial du composant.
      
              Ici, il est utilisÃ© pour lancer le fetch des donnÃ©es mÃ©tÃ©o
              au moment oÃ¹ le composant est montÃ© dans l'interface.
            */
            useEffect(() => {

                // 1) CrÃ©ation d'un contrÃ´leur permettant d'annuler la requÃªte fetch
                const controller = new AbortController();

                // 2) Fonction interne asynchrone qui appelle l'API
                async function fetchWeather() {
                    try {

                        // 3) Lancement de la requÃªte avec le signal permettant l'annulation
                        const response = await fetch(
                            "https://api.weather.gov/gridpoints/OKX/33,37/forecast",
                            { signal: controller.signal }
                        );

                        // 4) Conversion en JSON
                        const data = await response.json();

                        // 5) Mise Ã  jour de l'Ã©tat (dÃ©clenche un re-render normal)
                        setWeather(data);
                        setLoading(false);

                    } catch (error) {

                        // 6) Si l'erreur est une annulation â†’ on ne considÃ¨re pas Ã§a comme un vrai "Ã©chec"
                        if (error.name !== "AbortError") {
                            console.error("Erreur :", error);
                        }
                    }
                }

                // 7) Appel de la fonction de rÃ©cupÃ©ration
                fetchWeather();

                /*
                  8) Fonction de nettoyage (cleanup) appelÃ©e automatiquement quand :
        
                     - Le composant est dÃ©montÃ© (ex: l'utilisateur clique pour cacher WeatherData)
                     - useEffect doit se rÃ©-exÃ©cuter (pas le cas ici car [])
        
                  Elle annule la requÃªte en cours pour Ã©viter une mise Ã  jour
                  d'Ã©tat aprÃ¨s dÃ©montage.
                */
                return () => {
                    console.log("stop weather NY")
                    controller.abort() // TRES IMPORTANT pour stopper tout si dÃ©montÃ©
                }

                // [] = on exÃ©cute useEffect UNE SEULE FOIS (au montage uniquement)
            }, []);

            if (loading) return <p>Chargement des donnÃ©es mÃ©tÃ©o...</p>;

            const periods = weather?.properties?.periods ?? [];
            const current = periods[0];

            return (
                <div>
                    <h2>PrÃ©vision MÃ©tÃ©o - New York</h2>

                    {current ? (
                        <>
                            <h3>{current.name}</h3>
                            <p>{current.detailedForecast}</p>
                            <p>TempÃ©rature : {current.temperature}Â°{current.temperatureUnit}</p>
                        </>
                    ) : (
                        <p>Aucune donnÃ©e disponible.</p>
                    )}
                </div>
            );
        }

        ReactDOM.createRoot(document.getElementById("root")).render(<App />);

    </script>
</body>

</html>